@echo off
chcp 65001 >nul
setlocal

:: ==========================================
:: 1. 进入脚本所在目录
:: ==========================================
cd /d "%~dp0" || ( echo 无法进入目录 & pause & exit /b 1 )

:: ==========================================
:: 2. 检查 npm 是否可用
:: ==========================================
where npm >nul 2>&1
if %errorlevel% neq 0 (
    echo ❌ 错误: 未找到 npm 命令。请确保已安装 Node.js 并添加到 PATH。
    pause
    exit /b 1
)
echo ✅ 环境检查通过

:: ==========================================
:: 3. 自动清理被占用的端口 30101
:: ==========================================
set PORT=30101
echo 🧹 正在检查端口 %PORT% 是否被占用...
for /f "tokens=5" %%a in ('netstat -aon ^| findstr ":%PORT% " ^| findstr "LISTENING"') do (
    echo    正在结束占用端口的进程 PID: %%a
    taskkill /F /PID %%a >nul 2>&1
)
echo    端口检查完成，准备启动。

:: ==========================================
:: 4. 检查依赖并安装
:: ==========================================
if not exist "node_modules\" (
    echo 📦 检测到首次运行，正在安装依赖...
    npm install
    if %errorlevel% neq 0 (
        echo ❌ npm install 失败，请检查网络或 Node.js 版本。
        pause
        exit /b 1
    )
)

:: ==========================================
:: 5. 3 秒后自动打开浏览器
:: ==========================================
echo 🚀 正在启动服务器...
start "" cmd /c "timeout /t 3 /nobreak >nul && start http://localhost:%PORT%"

:: ==========================================
:: 6. 启动服务器
:: ==========================================
npm start

:: ==========================================
:: 7. 退出暂停（崩溃或正常退出时显示）
:: ==========================================
echo.
echo ========================================
echo ⚠️  程序已停止或发生崩溃。
echo 请向上滚动查看具体的错误报错信息 (Error/Exception)。
echo ========================================
pause
